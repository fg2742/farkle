<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Farkle — 5 Dice</title>
    <style>
        :root {
            --bg:#154734;
            --card:#fff;
            --text:#fff;
            --accent:#ffd54f;
            --btn:#2e7d32;
            --danger:#e57373;
        }

        html, body {
            height:100%;
            margin:0;
            font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
        }

        body {
            background:linear-gradient(180deg,#0e4230 0%, var(--bg) 100%);
            color:var(--text);
            display:flex;
            justify-content:center;
            padding:16px;
        }

        .app {
            width:100%;
            max-width:820px;
            background: rgba(255,255,255,0.04);
            border-radius:12px;
            padding:14px;
            box-sizing:border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }

        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
            gap:12px;
        }

        h1 {
            font-size:20px;
            margin:0;
        }

        .scoreboard {
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            margin-bottom:10px;
        }

        .player {
            background: rgba(255,255,255,0.06);
            padding:8px 10px;
            border-radius:8px;
            min-width:140px;
            text-align:left;
        }

        .player.current {
            outline: 2px solid var(--accent);
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        }

        .player .name {
            font-weight:700;
        }

        .player .score {
            font-size:18px;
            margin-top:6px;
        }

        .topbar {
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
        }

        .turn-info {
            font-size:14px;
        }

        .dice-rows {
            display:flex;
            flex-direction:column;
            gap:10px;
            align-items:center;
        }

        .row-label {
            font-size:13px;
            opacity:0.9;
            margin-bottom:6px;
            text-align:center;
        }

        .dice-container {
            display:flex;
            flex-wrap:wrap;
            justify-content:center;
            gap:8px;
            margin:12px 0;
        }

        .dice {
            width:72px;
            height:72px;
            background: var(--card);
            color:#000;
            border-radius:12px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:40px;
            user-select:none;
            cursor:pointer;
            border:4px solid transparent;
            transition: transform 0.14s, border 0.14s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .dice.tentative {
            border-color:#ffb74d;
            transform:scale(1.05);
        }

        .dice.locked {
            border-color:var(--accent);
            transform:scale(1.05);
            cursor:default;
        }

        .controls {
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            justify-content:center;
            margin-top:8px;
        }

        button {
            background:var(--btn);
            color:#fff;
            border:none;
            padding:10px 14px;
            border-radius:8px;
            font-weight:700;
            cursor:pointer;
            min-width:110px;
            box-shadow:0 6px 14px rgba(0,0,0,0.25);
        }

        button.secondary {
            background:#37474f;
            min-width:120px;
        }

        button.danger {
            background:var(--danger);
            min-width:120px;
        }

        button:disabled {
            opacity:0.45;
            cursor:not-allowed;
            box-shadow:none;
        }

        .message {
            margin-top:12px;
            text-align:center;
            font-weight:700;
            min-height:24px;
        }

        .meta {
            font-size:13px;
            opacity:0.9;
            margin-top:10px;
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            justify-content:center;
        }

        @media (max-width:520px) {
            .dice { width:56px; height:56px; font-size:32px; }
            .player { min-width:96px; padding:6px; }
            button { min-width:86px; padding:8px 10px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div><h1>Farkle — 5 Dice</h1></div>
            <div id="roundLabel">Round 1</div>
        </header>

        <div class="scoreboard" id="scoreboard"></div>

        <div class="topbar">
            <div class="turn-info" id="turnInfo"></div>
            <div><strong>Turn points:</strong> <span id="turnPoints">0</span></div>
            <div><strong>Pending points:</strong> <span id="pendingPoints">0</span></div>
        </div>

        <div class="dice-rows">
            <div>
                <div class="row-label"><strong>Held / Locked</strong></div>
                <div class="dice-container" id="heldContainer"></div>
            </div>
            <div>
                <div class="row-label"><strong>Current Roll</strong></div>
                <div class="dice-container" id="rollContainer"></div>
            </div>
        </div>

        <div style="text-align:center; margin-top:4px;">
            <small>Tap dice in current roll to tentatively select/unselect before committing with Roll, Bank, or End Turn.</small>
        </div>

        <div class="controls">
            <button id="rollBtn">Roll</button>
            <button id="bankBtn" class="secondary">Bank</button>
            <button id="endBtn" class="danger" style="display:none;">End Turn</button>
            <button id="newBtn" class="secondary">New Game</button>
        </div>

        <div class="message" id="message"></div>
        <div class="meta" id="meta"></div>
    </div>

    <script>
    const DICE_UNICODE = ['\u2680','\u2681','\u2682','\u2683','\u2684','\u2685'];

    let players = [], currentPlayer = 0, round = 1;
    let rolledDice = [], tentativeSet = new Set(), heldDice = [];
    let turnPoints = 0, hasRolledThisTurn = false, farkled = false;

    const heldContainer = document.getElementById('heldContainer');
    const rollContainer = document.getElementById('rollContainer');
    const turnInfoEl = document.getElementById('turnInfo');
    const turnPointsEl = document.getElementById('turnPoints');
    const messageEl = document.getElementById('message');
    const scoreboardEl = document.getElementById('scoreboard');
    const roundLabel = document.getElementById('roundLabel');

    // ------------------------------
    // UTILITY FUNCTIONS
    // ------------------------------
    function countsOf(arr){
        const c=[0,0,0,0,0,0];
        arr.forEach(v=>c[v-1]++);
        return c;
    }

    function tripleValue(f){
        return f===1?1000:f*100;
    }

    function checkStraight(roll){
        if(roll.length!==5) return false;
        const s=[...roll].sort((a,b)=>a-b).join(',');
        return s==='1,2,3,4,5'||s==='2,3,4,5,6';
    }

    function hasScoringDice(roll){
        if(roll.length===0) return false;
        if(roll.some(v=>v===1||v===5)) return true;
        const c=countsOf(roll);
        if(c.some(count=>count>=3)) return true;
        if(roll.length===5 && checkStraight(roll)) return true;
        return false;
    }

    function rand1to6(){ return Math.floor(Math.random()*6)+1; }

    function setMessage(msg){ messageEl.textContent=msg; }

    // ------------------------------
    // PLAYER SETUP
    // ------------------------------
    function promptPlayers(){
        let num=parseInt(prompt("Number of players (1-4):","2"));
        if(isNaN(num)||num<1||num>4) num=2;
        players=[];
        for(let i=0;i<num;i++){
            let n=prompt(`Name for player ${i+1}:`,`Player ${i+1}`);
            players.push({name:n||`Player ${i+1}`, score:0, qualified:false});
        }
        currentPlayer=0; round=1;
        resetTurnState();
        roundLabel.textContent = 'Round ' + round;
    }

    function resetTurnState(){
        rolledDice=[]; tentativeSet.clear(); heldDice=[];
        turnPoints=0; hasRolledThisTurn=false; farkled=false;
        setMessage(`${players[currentPlayer].name}'s turn — press Roll.`);
        renderAll();
    }

    // ------------------------------
    // DICE & SCORING
    // ------------------------------
    function calculateScore(dice){
        if(dice.length===0) return 0;
        const c=countsOf(dice);
        let score=0;

        for(let i=0;i<6;i++){
            if(c[i]>=3) score+=tripleValue(i+1);
        }

        // leftover 1s and 5s
        c[0]%=3; c[4]%=3;
        score+=c[0]*100 + c[4]*50;

        if(dice.length===5 && checkStraight(dice)) score=1500;
        return score;
    }

    function commitTentativeAndAward(){
        if(tentativeSet.size===0) return 0;

        const newHeld=[], remainingDice=[];
        // tentativeSet has indices relative to current rolledDice
        rolledDice.forEach((die,i)=>{
            if(tentativeSet.has(i)) newHeld.push(die);
            else remainingDice.push(die);
        });

        heldDice=heldDice.concat(newHeld);
        rolledDice=remainingDice;
        tentativeSet.clear();

        const award=calculateScore(newHeld);
        turnPoints+=award;
        if(award>0) setMessage(`Added ${award} points! Total this turn: ${turnPoints}`);
        renderAll();
        return award;
    }

    function doRoll(){
        if(farkled) return;

        // commit any tentative selections first
        commitTentativeAndAward();

        if(heldDice.length===5) heldDice=[]; // hot dice reset

        const toRoll = 5 - heldDice.length;
        rolledDice=[];
        for(let i=0;i<toRoll;i++) rolledDice.push(rand1to6());
        // Clear the existing set instead of reassigning to preserve references
        tentativeSet.clear();

        if(!hasScoringDice(rolledDice)){
            farkled=true;
            setMessage("You rolled a Farkle! Click End Turn.");
        } else {
            setMessage(`${players[currentPlayer].name}'s turn — select dice and Roll/Bank.`);
        }
        hasRolledThisTurn=true;
        renderAll();
    }

    function bankTurn(){
        commitTentativeAndAward();
        const player=players[currentPlayer];

        if(!player.qualified){
            if(turnPoints>=600){
                player.qualified=true;
                player.score+=turnPoints;
                setMessage(`${player.name} qualified with ${turnPoints} points!`);
                nextPlayerAfterEnd();
            } else {
                setMessage(`${player.name} needs at least 600 points to qualify.`);
            }
            return;
        }

        // Already qualified
        player.score+=turnPoints;
        setMessage(`${player.name} banked ${turnPoints} points.`);
        nextPlayerAfterEnd();
    }

    function endTurn() {
    // If they Farkled, no points should be added — just move to next player
    if (farkled) {
        setMessage(`${players[currentPlayer].name} Farkled! No points added.`);
        turnPoints = 0; // clear pending points
        nextPlayerAfterEnd();
        return;
    }

    commitTentativeAndAward();
    const player = players[currentPlayer];

    // 600-point qualification rule (same behavior as bankTurn)
    if (!player.qualified) {
        if (turnPoints >= 600) {
            player.qualified = true;
            player.score += turnPoints;
            setMessage(`${player.name} qualified with ${turnPoints} points!`);
        } else {
            setMessage(`${player.name} needs at least 600 points to qualify — no points added.`);
        }
        nextPlayerAfterEnd();
        return;
    }

    // Already qualified
    player.score += turnPoints;
    setMessage(`${player.name} ends turn with ${turnPoints} points!`);
    nextPlayerAfterEnd();
}


    // ------------------------------
    // DICE RENDERING & INTERACTIONS
    // ------------------------------
    function toggleTentative(idx){
        // Defensive: only toggle if idx is valid for current rolledDice
        if(typeof idx !== 'number') return;
        if(idx < 0 || idx >= rolledDice.length) return;
        if(tentativeSet.has(idx)) tentativeSet.delete(idx);
        else tentativeSet.add(idx);
        renderAll();
    }

    function renderDice(container,diceArr,highlightSet,isLocked=false){
        container.innerHTML='';
        diceArr.forEach((v,i)=>{
            const el=document.createElement('div');
            el.className='dice';
            if(isLocked) el.classList.add('locked');
            else if(highlightSet.has(i)) el.classList.add('tentative');
            el.textContent=DICE_UNICODE[v-1];
            if(!isLocked){
                // attach a click handler that references the index at time of render
                el.dataset.idx = i;
                el.onclick = () => toggleTentative(Number(el.dataset.idx));
            } else {
                el.onclick = null;
            }
            container.appendChild(el);
        });
    }

    function renderAll(){
        renderDice(heldContainer,heldDice,new Set(),true);
        renderDice(rollContainer,rolledDice,tentativeSet);
        turnInfoEl.textContent=`Current player: ${players[currentPlayer].name}`;
        turnPointsEl.textContent = turnPoints;
        document.getElementById('pendingPoints').textContent = turnPoints;
        renderScoreboard();
        updateControls();
    }

    function renderScoreboard(){
        scoreboardEl.innerHTML='';
        players.forEach((p,i)=>{
            const el=document.createElement('div');
            el.className='player'+(i===currentPlayer?' current':'');
            el.innerHTML=`<div class="name">${p.name}</div><div class="score">${p.score}</div>`;
            scoreboardEl.appendChild(el);
        });
    }

    function updateControls(){
        const rollBtn=document.getElementById('rollBtn');
        const bankBtn=document.getElementById('bankBtn');
        const endBtn=document.getElementById('endBtn');

        if(farkled){
            rollBtn.disabled=true;
            bankBtn.disabled=true;
            endBtn.style.display='inline-block';
            return;
        }

        rollBtn.disabled=false;
        bankBtn.disabled=false;
        endBtn.style.display=(heldDice.length>0 || tentativeSet.size>0)?'inline-block':'none';
    }

    // ------------------------------
    // ROUND / PLAYER MANAGEMENT
    // ------------------------------
    function nextPlayerAfterEnd(){
        currentPlayer=(currentPlayer+1)%players.length;
        if(currentPlayer===0){
            round++;
            roundLabel.textContent='Round '+round;
        }
        resetTurnState();
    }

    // ------------------------------
    // INITIALIZE
    // ------------------------------
    window.onload=function(){
        document.getElementById('rollBtn').onclick=doRoll;
        document.getElementById('bankBtn').onclick=bankTurn;
        document.getElementById('endBtn').onclick=endTurn;
        document.getElementById('newBtn').onclick=promptPlayers;
        promptPlayers();
    }
</script>

</body>
</html>
